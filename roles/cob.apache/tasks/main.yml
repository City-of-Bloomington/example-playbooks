---
# tasks file for cob.apache

- name: Install apache and related packages
  apt:
    name: "{{ item }}"
    state: present
  tags: apache
  # defined in defaults/main.yml
  with_items:
    - apache2

- name: Add mod_rewrite configuration
  copy: src=rewrite.conf dest=/etc/apache2/mods-available/rewrite.conf force=no

- apache2_module: state=present name=rewrite
- apache2_module: state=present name=alias

# recurse=yes allows similar functionality to mkdir -p
- file: path=/srv/sites/master state=directory recurse=yes

# if putting things like /srv/solr directory in /srv
# then solr user needs to be able to at least execute permissions to chdir
- file: path=/srv              state=directory owner=www-data group=staff mode=2775

# need to be careful with recurse here
# especially for things like solr data dir that expects to be owned by solr user
- file: path=/srv/sites        state=directory owner=www-data group=staff mode=2770 recurse=yes

- command: cp /var/www/html/index.html /srv/sites/master

- name: Update default configuration
  template:
    src: 000-default.conf.j2
    dest: /etc/apache2/sites-available/000-default.conf
    owner: root
    group: root
    mode: 0644

- service: name=apache2 state=restarted

# TODO:
#add users to staff group, or add server to domain for Active Directory accounts
- user: name={{ ansible_user }} groups=staff

- name: Configure the firewall (http)
  ufw: rule=allow port=http
